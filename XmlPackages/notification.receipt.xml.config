<?xml version="1.0"?>
<package displayname="Order Receipt" version="2.1" debug="false">

    <!-- ###################################################################################################### -->
    <!-- Copyright AspDotNetStorefront.com, 1995-2006.  All Rights Reserved.					                -->
    <!-- http://www.aspdotnetstorefront.com														                -->
    <!-- For details on this license please visit  the product homepage at the URL above.		                -->
    <!-- THE ABOVE NOTICE MUST REMAIN INTACT.                                                                   -->
    <!-- $Header: /v6.1/Web/XmlPackages/notification.receipt.xml.config 1     12/30/05 2:33p Administrator $	-->
    <!--                                                                                                        -->
    <!-- ###################################################################################################### -->

    <query name="Order" rowElementName="OrderInfo">
        <sql>
            <![CDATA[
            select o.* ,
                a.AddressIDs,
                case when a.Downloads = a.ItemCount then 1 else 0 end allDownloads,
                case when a.FreeShipping = a.ItemCount then 1 else 0 end allFreeShipping,
                case when a.SystemProducts = a.ItemCount then 1 else 0 end allSystemproducts,
                case b.multiship when 1 then 0 else 1 end multiship,
                case b.GiftRegistryItems when 0 then 0 else 1 end hasgiftregistryitems,
                c.CustomerID as CustomerID
            From orders o with (NOLOCK) 
                join (select ordernumber, count(distinct sc.ShippingAddressID) AddressIDs, sum(sc.IsDownload) Downloads, sum(sc.FreeShipping) FreeShipping, sum(sc.isSystem) SystemProducts, count(*) ItemCount From Orders_ShoppingCart sc with (NOLOCK) where ordernumber = @ordernum group by ordernumber ) a on o.ordernumber = a.ordernumber
                join (select OrderNumber, count(distinct ShippingAddressID) multiship, sum(case GiftRegistryForCustomerID when 0 then 0 else 1 end) GiftRegistryItems  FROM dbo.Orders_ShoppingCart where ordernumber = @ordernum group by OrderNumber) b on o.OrderNumber = b.OrderNumber
                join dbo.customer c on o.customerid = c.customerid
            where o.ordernumber = @ordernum
            ]]>
        </sql>
        <queryparam paramname="@ordernum" paramtype="runtime" requestparamname="ordernumber" defvalue="0" sqlDataType="int" validationpattern="^\d{1,9}$"/>
        <queryparam paramname="@customerid" paramtype="runtime" requestparamname="CustomerID" defvalue="0" sqlDataType="int" validationpattern="^\d{1,9}$"/>
    </query>
    <query name="OrderItems" rowElementName="lineitem">
        <sql>
            <![CDATA[
            SELECT       s.ShoppingCartRecID, s.OrderNumber, s.ProductID, s.VariantID, s.Quantity, s.ChosenColor, s.ChosenSize, s.OrderedProductName, 
                      s.OrderedProductVariantName, s.OrderedProductSKU, s.OrderedProductPrice, s.OrderedProductRegularPrice, s.OrderedProductSalePrice, 
                      s.OrderedProductExtendedPrice, s.OrderedProductQuantityDiscountName, s.OrderedProductQuantityDiscountID, 
                      s.OrderedProductQuantityDiscountPercent, s.IsShipSeparately, s.IsDownload, s.FreeShipping, s.TextOption, s.ShippingMethod, s.Notes, 
                      s.ExtensionData, s.CustomerEntersPrice, s.GiftRegistryForCustomerID, s.ShippingAddressID, s.SizeOptionPrompt, s.ColorOptionPrompt, 
                      s.TextOptionPrompt, s.IsTaxable, s.TaxClassID, s.TaxRate, ISNULL(s.IsAKit, 0) AS isakit, ISNULL(s.IsAPack, 0) AS isapack, ISNULL(s.IsSystem, 0)
                      AS IsSystem,
(SELECT TOP 1    Section.Name
FROM         Section INNER JOIN
ProductSection with (NOLOCK) ON Section.SectionID = ProductSection.SectionID WHERE s.ProductID = ProductSection.ProductID) AS LocationName, 
(SELECT TOP 1    Base.Name
FROM         Section INNER JOIN
ProductSection with (NOLOCK) ON Section.SectionID = ProductSection.SectionID INNER JOIN
Section as loc with (NOLOCK)  ON ProductSection.SectionID = loc.SectionID INNER JOIN
Section as base with (NOLOCK)  ON loc.ParentSectionID = base.SectionID
WHERE s.ProductID = ProductSection.ProductID) AS Base 
          
 from dbo.Orders_ShoppingCart s with (NOLOCK) 
            where s.ordernumber = @ordernum
            ]]>
        </sql>
        <queryparam paramname="@ordernum" paramtype="runtime" requestparamname="ordernumber" defvalue="0" sqlDataType="int" validationpattern="^\d{1,9}$"/>
    </query>
    <query name="CustomOrderItems" rowElementName="Customitem">
        <sql>
            <![CDATA[
        select * From dbo.Orders_CustomCart with (NOLOCK) where ordernumber = @ordernum
        ]]>
        </sql>
        <queryparam paramname="@ordernum" paramtype="runtime" requestparamname="ordernumber" defvalue="0" sqlDataType="int" validationpattern="^\d{1,9}$"/>
    </query>
    <query name="KitOrderItems" rowElementName="kititem">
        <sql>
       <![CDATA[
                select * From dbo.Orders_KitCart with (NOLOCK) where ordernumber = @ordernum and KitGroupTypeID<>901
        ]]>
        </sql>
        <queryparam paramname="@ordernum" paramtype="runtime" requestparamname="ordernumber" defvalue="0" sqlDataType="int" validationpattern="^\d{1,9}$"/>
    </query>

    <query name="OrderGiftCards" rowElementName="GiftCard">
        <sql>
            <![CDATA[
            select ShoppingCartRecID, SerialNumber from dbo.GiftCard where ordernumber = @ordernum
            ]]>
        </sql>
        <queryparam paramname="@ordernum" paramtype="runtime" requestparamname="ordernumber" defvalue="0" sqlDataType="int" validationpattern="^\d{1,9}$"/>
    </query>

    <PackageTransform>
        <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:aspdnsf="urn:aspdnsf" exclude-result-prefixes="aspdnsf">
            <xsl:output method="html" omit-xml-declaration="yes" encoding="ISO-8859-1"/>
            <xsl:param name="AppConfigReceiptHeader" select="aspdnsf:AppConfig('ReceiptHeader')" />
            <xsl:param name="AppConfigReceiptFooter" select="aspdnsf:AppConfig('ReceiptFooter')" />
            <xsl:param name="TopicReceiptHeader" select="aspdnsf:Topic('ReceiptHeader')"  />
            <xsl:param name="TopicReceiptFooter" select="aspdnsf:Topic('ReceiptFooter')"  />
            <xsl:param name="LocaleSetting" select="/root/Runtime/LocaleSetting" />
            <xsl:param name="WebConfigLocaleSetting" select="/root/Runtime/WebConfigLocaleSetting" />
            <xsl:param name="ReceiptHideStoreVersion" select="aspdnsf:AppConfigBool('ReceiptHideStoreVersion')" />
            <xsl:param name="ShowCustomerServiceNotesInReceipts" select="aspdnsf:AppConfigBool('ShowCustomerServiceNotesInReceipts')" />
            <xsl:param name="DefaultSizeOptionPrompt" select="aspdnsf:StringResource('AppConfig.SizeOptionPrompt')" />
            <xsl:param name="DefaultColorOptionPrompt" select="aspdnsf:StringResource('AppConfig.ColorOptionPrompt')" />
            <xsl:param name="DefaultTextOptionPrompt" select="aspdnsf:StringResource('common.cs.70')" />

          <xsl:param name="CustomerID">
            <xsl:value-of select="/root/Order/OrderInfo/CustomerID" />
          </xsl:param>
          <xsl:param name="StoreURL">
            <xsl:value-of select="/root/Runtime/StoreUrl" />
            </xsl:param>
            <xsl:param name="StyleURL"><xsl:value-of select="$StoreURL" />skins/skin_<xsl:value-of select="aspdnsf:SkinID()" />/style.css</xsl:param>
            <xsl:param name="nocc">
                <xsl:choose>
                    <xsl:when test="aspdnsf:EvalBool(/root/QueryString/nocc)='true'">1</xsl:when>
                    <xsl:otherwise>0</xsl:otherwise>
                </xsl:choose>
            </xsl:param>
            <xsl:template match="/">
                <html>
                    <head>
                        <link rel="stylesheet" type="text/css" href="{$StyleURL}"></link>
                        <title>
                            <xsl:value-of select="aspdnsf:AppConfig('StoreName')" disable-output-escaping="yes" />&#32;<xsl:value-of select="aspdnsf:StringResource('common.cs.7', $LocaleSetting)" disable-output-escaping="yes" /><xsl:if test="/root/Order/OrderInfo/PaymentMethod = 'REQUESTQUOTE'"> (REQUEST FOR QUOTE)</xsl:if>
                        </title>
                    </head>
                    <body>
                        <p align="center">
                            <b>
                                <font size="3">
                                    <xsl:value-of select="aspdnsf:AppConfig('StoreName')" disable-output-escaping="yes" />&#32;<xsl:value-of select="aspdnsf:StringResource('common.cs.7', $LocaleSetting)" disable-output-escaping="yes" /><xsl:if test="/root/Order/OrderInfo/PaymentMethod = 'REQUESTQUOTE'"> (REQUEST FOR QUOTE)</xsl:if>
                                </font>
								<br/>
                                <font size="1">
                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.71', $LocaleSetting)" disable-output-escaping="yes" />
                                </font>
                            </b>
                        </p>
                        <xsl:choose>
                            <xsl:when test="$TopicReceiptHeader!=''">
                                <xsl:value-of select="$TopicReceiptHeader" disable-output-escaping="yes" />
                            </xsl:when>
                            <xsl:otherwise>
                                <xsl:value-of select="$AppConfigReceiptHeader" disable-output-escaping="yes" />
                            </xsl:otherwise>
                        </xsl:choose>
                        <table border="0" cellspacing="2" cellpadding="0" >
                            <tr>
                                <td align="left" width="20%">
                                    <xsl:apply-templates select="/root/Order/OrderInfo" />
                                </td>
                            </tr>
                        </table>
                        <xsl:choose>
                            <xsl:when test="$TopicReceiptFooter!=''">
                                <xsl:value-of select="$TopicReceiptFooter" disable-output-escaping="yes" />
                            </xsl:when>
                            <xsl:otherwise>
                                <xsl:value-of select="$AppConfigReceiptFooter" disable-output-escaping="yes" />
                            </xsl:otherwise>
                        </xsl:choose>
                        <p>
                            <xsl:value-of select="aspdnsf:StringResource('order.cs.72', $LocaleSetting)" disable-output-escaping="yes" />
                        </p>
                        <p>
                            <xsl:value-of select="aspdnsf:AppConfig('StoreName')" />
                            <br/>
                            <a href="{/root/System/StoreUrl}">
                                <xsl:value-of select="/root/System/StoreUrl" />
                            </a>
                        </p>
                    </body>
                </html>
            </xsl:template>


            <xsl:template match="OrderInfo">
                <xsl:param name="pCouponDescription" select="aspdnsf:GetMLValue(CouponDescription)"></xsl:param>

                <xsl:param name="CleanPaymentMethod">
                    <xsl:value-of select="aspdnsf:CleanPaymentMethod(PaymentMethod)" disable-output-escaping="yes" />
                </xsl:param>
                <div class="report">
                    <table cellpadding="0" cellspacing="0" width="100%">
                        <tr>
                            <td align="left" valign="top">
                                <table border="0" cellspacing="2" cellpadding="0" >
                                    <tr>
                                        <td align="left" width="20%">
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.22', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td colspan="3" width="80%" align="left">
                                            <xsl:value-of select="OrderNumber" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" width="20%">
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.23', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td colspan="3" width="80%" align="left">
                                            <xsl:value-of select="CustomerID" />
                                        </td>
                                    </tr>
                                    <xsl:if test="boolean(VATRegistrationID) and VATRegistrationID!=''">
                                        <tr>
                                            <td><xsl:value-of select="aspdnsf:StringResource('order.cs.86', $LocaleSetting)" disable-output-escaping="yes" /></td>
                                            <td><xsl:value-of select="VATRegistrationID" /></td>
                                        </tr>
                                    </xsl:if>
                                    <tr>
                                        <td align="left" width="20%">
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.24', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td colspan="3" width="80%" align="left">
                                            <xsl:value-of select="Email" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" width="20%">
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.25', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td colspan="3" width="80%" align="left">
                                            <xsl:value-of select="OrderDate" />
                                        </td>
                                    </tr>
                                    <xsl:if test="ReceiptHideStoreVersion='true'">
                                        <tr>
                                            <td align="left" width="20%">
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.26', $LocaleSetting)" disable-output-escaping="yes" />
                                            </td>
                                            <td colspan="3" width="80%" align="left">
                                                <xsl:value-of select="aspdnsf:Store_Version()" />
                                            </td>
                                        </tr>
                                    </xsl:if>
                                    <xsl:if test="LevelID!='' and number(LevelID)!=0">
                                        <tr>
                                            <td align="left" width="20%">
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.27', $LocaleSetting)" disable-output-escaping="yes" />
                                            </td>
                                            <td colspan="3" width="80%" align="left">
                                                <xsl:value-of select="LevelName" />:
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.5', $LocaleSetting)" disable-output-escaping="yes" /> =
                                                <xsl:value-of select="LevelDiscountPercent" />%,
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.6', $LocaleSetting)" disable-output-escaping="yes" /> =
                                                <xsl:value-of select="aspdnsf:FormatCurrency(LevelDiscountAmount)" />,
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.7', $LocaleSetting)" disable-output-escaping="yes" /> =
                                                <xsl:value-of select="aspdnsf:EvalBool(LevelHasFreeShipping)" />,
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.8', $LocaleSetting)" disable-output-escaping="yes" /> =
                                                <xsl:value-of select="aspdnsf:EvalBool(LevelAllowsQuantityDiscounts)" />,
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.9', $LocaleSetting)" disable-output-escaping="yes" /> =
                                                <xsl:value-of select="aspdnsf:EvalBool(LevelHasNoTax)" />,
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.10', $LocaleSetting)" disable-output-escaping="yes" /> =
                                                <xsl:value-of select="aspdnsf:EvalBool(LevelAllowsCoupons)" />,
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.11', $LocaleSetting)" disable-output-escaping="yes" /> =
                                                <xsl:value-of select="aspdnsf:EvalBool(LevelDiscountsApplyToExtendedPrices)" />
                                            </td>
                                        </tr>
                                    </xsl:if>
                                    <tr>
                                        <td align="left" width="20%">
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.28', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td colspan="3" width="80%" align="left">
                                            <xsl:choose>
                                                <xsl:when test="CouponCode!='' and CouponType != 2">
                                                    <xsl:value-of select="aspdnsf:Decode(CouponCode)" disable-output-escaping="yes" /><xsl:if test="$pCouponDescription!=''">&#0160;</xsl:if>
                                                    <xsl:value-of select="$pCouponDescription" disable-output-escaping="yes" />,&#0160;
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.12', $LocaleSetting)" disable-output-escaping="yes" />&#0160;
                                                    <xsl:choose>
                                                        <xsl:when test="CouponIncludesFreeShipping=1">
                                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.13', $LocaleSetting)" disable-output-escaping="yes" />
                                                        </xsl:when>
                                                        <xsl:otherwise>
                                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.14', $LocaleSetting)" disable-output-escaping="yes" />
                                                        </xsl:otherwise>
                                                    </xsl:choose>,&#0160;
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.15', $LocaleSetting)" disable-output-escaping="yes" />&#0160;
                                                    <xsl:choose>
                                                        <xsl:when test="CouponDiscountAmount!=0">
                                                            <xsl:value-of select="aspdnsf:FormatCurrency(CouponDiscountAmount)" />
                                                        </xsl:when>
                                                        <xsl:otherwise>
                                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.16', $LocaleSetting)" disable-output-escaping="yes" />
                                                        </xsl:otherwise>
                                                    </xsl:choose>,&#0160;
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.17', $LocaleSetting)" disable-output-escaping="yes" />&#0160;
                                                    <xsl:choose>
                                                        <xsl:when test="CouponDiscountPercent!=0">
                                                            <xsl:value-of select="CouponDiscountPercent" />%
                                                        </xsl:when>
                                                        <xsl:otherwise>
                                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.16', $LocaleSetting)" disable-output-escaping="yes" />
                                                        </xsl:otherwise>
                                                    </xsl:choose>
                                                </xsl:when>
                                                <xsl:otherwise>
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.29', $LocaleSetting)" disable-output-escaping="yes" />
                                                </xsl:otherwise>
                                            </xsl:choose>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" width="20%">
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.30', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td colspan="3" width="80%" align="left">
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.29', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" width="20%">
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.31', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td colspan="3" width="80%" align="left">
                                            <xsl:choose>
                                                <xsl:when test="PaymentMethod='MICROPAY'">
                                                    <xsl:value-of select="aspdnsf:StringResource('account.aspx.11', $LocaleSetting)" disable-output-escaping="yes" />
                                                </xsl:when>
                                                <xsl:otherwise>
                                                    <xsl:value-of select="PaymentMethod" />
                                                </xsl:otherwise>
                                            </xsl:choose>
                                        </td>
                                    </tr>
                                    <xsl:choose>
                                        <xsl:when test="$CleanPaymentMethod='CREDITCARD'">
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.32', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="CardType" />
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.33', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="CardName" />
                                                </td>
                                            </tr>
                                            <xsl:value-of select="aspdnsf:GetOrderReceiptCCNumber(Last4, CardType, CardExpirationMonth, CardExpirationYear, /root/QueryString/pwd, $nocc)" disable-output-escaping="yes" />
                                        </xsl:when>
                                        <xsl:when test="$CleanPaymentMethod='ECHECK'">
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.36', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="eCheckBankAccountName" />
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.37', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="eCheckBankAccountType" />
                                                </td>
                                            </tr>
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.38', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="eCheckBankName" />
                                                </td>
                                            </tr>
                                            <xsl:if test="/root/QueryString/pwd = aspdnsf:AppConfig('OrderShowCCPwd') and $nocc=0">
                                                <tr>
                                                    <td align="left" width="20%"></td>
                                                    <td colspan="3" width="80%" align="left"></td>
                                                </tr>
                                            </xsl:if>
                                        </xsl:when>
                                        <xsl:when test="$CleanPaymentMethod='PURCHASEORDER'">
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.41', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="PONumber" />
                                                </td>
                                            </tr>
                                        </xsl:when>
                                        <xsl:when test="$CleanPaymentMethod='CODMONEYORDER'">
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.41', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="PONumber" />
                                                </td>
                                            </tr>
                                        </xsl:when>
                                        <xsl:when test="$CleanPaymentMethod='CODCOMPANYCHECK'">
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.41', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="PONumber" />
                                                </td>
                                            </tr>
                                        </xsl:when>
                                        <xsl:when test="$CleanPaymentMethod='CODNET30'">
                                            <tr>
                                                <td align="left" width="20%">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.41', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td colspan="3" width="80%" align="left">
                                                    <xsl:value-of select="PONumber" />
                                                </td>
                                            </tr>
                                        </xsl:when>
                                    </xsl:choose>
                                    <xsl:if test="OrderNotes!=''">
                                        <tr>
                                            <td align="left" width="20%">
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.42', $LocaleSetting)" disable-output-escaping="yes" />
                                            </td>
                                            <td colspan="3" width="80%" align="left">
                                                <xsl:value-of select="OrderNotes" />
                                            </td>
                                        </tr>
                                    </xsl:if>
                                    <xsl:if test="CustomerServiceNotes!='' and $ShowCustomerServiceNotesInReceipts = 'true'">
                                        <tr>
                                            <td align="left" width="20%">
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.43', $LocaleSetting)" disable-output-escaping="yes" />
                                            </td>
                                            <td colspan="3" width="80%" align="left">
                                                <xsl:value-of select="CustomerServiceNotes" />
                                            </td>
                                        </tr>
                                    </xsl:if>
                                    <tr>
                                        <td colspan="4" height="10"></td>
                                    </tr>
                                    <tr>
                                        <td align="left" width="20%">
                                            <b>
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.82')" disable-output-escaping="yes" />
                                            </b>
                                        </td>
                                        <td width="40%">
                                            <b>
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.58', $LocaleSetting)" disable-output-escaping="yes" />
                                            </b>
                                        </td>
                                        <td width="1%">&#160;</td>
                                        <td width="39%">
                                            <xsl:if test="/root/Order/OrderInfo/multiship=0">
                                            <b>
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.57', $LocaleSetting)" disable-output-escaping="yes" />
                                            </b>
                                            </xsl:if>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" >
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.59', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td>
                                            <xsl:value-of select="BillingFirstName" />&#32;<xsl:value-of select="BillingLastName" />
                                        </td>
                                        <td>&#160;</td>
                                        <td>
                                            <xsl:value-of select="ShippingFirstName" />&#32;<xsl:value-of select="ShippingLastName" />
                                        </td>
                                    </tr>
                                    <xsl:if test="BillingCompany!='' or ShippingCompany!=''">
                                        <tr>
                                            <td align="left" >
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.60', $LocaleSetting)" disable-output-escaping="yes" />
                                            </td>
                                            <td>
                                                <xsl:value-of select="BillingCompany" />
                                            </td>
                                            <td>&#160;</td>
                                            <td>
                                                <xsl:value-of select="ShippingCompany" />
                                            </td>
                                        </tr>
                                    </xsl:if>
                                    <tr>
                                        <td align="left" >
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.61', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td>
                                            <xsl:value-of select="BillingAddress1" />
                                        </td>
                                        <td>&#160;</td>
                                        <td>
                                            <xsl:value-of select="ShippingAddress1" />
                                        </td>
                                    </tr>
                                    <xsl:if test="BillingAddress2!='' or ShippingAddress2!=''">
                                        <tr>
                                            <td align="left" >
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.61', $LocaleSetting)" disable-output-escaping="yes" />
                                            </td>
                                            <td>
                                                <xsl:value-of select="BillingAddress2" />
                                            </td>
                                            <td>&#160;</td>
                                            <td>
                                                <xsl:value-of select="ShippingAddress2" />
                                            </td>
                                        </tr>
                                    </xsl:if>
                                    <xsl:if test="BillingSuite!='' or ShippingSuite!=''">
                                        <tr>
                                            <td align="left" >
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.61', $LocaleSetting)" disable-output-escaping="yes" />
                                            </td>
                                            <td>
                                                <xsl:value-of select="BillingSuite" />
                                            </td>
                                            <td>&#160;</td>
                                            <td>
                                                <xsl:value-of select="ShippingSuite" />
                                            </td>
                                        </tr>
                                    </xsl:if>
                                    <tr>
                                        <td align="left" >
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.63', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td>
                                            <xsl:value-of select="BillingCity" />
                                        </td>
                                        <td>&#160;</td>
                                        <td>
                                            <xsl:value-of select="ShippingCity" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" >
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.64', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td>
                                            <xsl:value-of select="BillingState" />
                                        </td>
                                        <td>&#160;</td>
                                        <td>
                                            <xsl:value-of select="ShippingState" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" >
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.65', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td>
                                            <xsl:value-of select="BillingZip" />
                                        </td>
                                        <td>&#160;</td>
                                        <td>
                                            <xsl:value-of select="ShippingZip" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" >
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.66', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td>
                                            <xsl:value-of select="BillingCountry" />
                                        </td>
                                        <td>&#160;</td>
                                        <td>
                                            <xsl:value-of select="ShippingCountry" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td align="left" >
                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.67', $LocaleSetting)" disable-output-escaping="yes" />
                                        </td>
                                        <td>
                                            <xsl:value-of select="BillingPhone" />
                                        </td>
                                        <td>&#160;</td>
                                        <td>
                                            <xsl:value-of select="ShippingPhone" />
                                        </td>
                                    </tr>
                                </table>
                                <br/>
                                <br/>
                                <div align="left">
                                    <table width="100%" cellpadding="0" cellspacing="0" border="0">
                                        <tr>
                                            <td align="left" valign="middle">
                                                <b>
                                                    <xsl:value-of select="aspdnsf:StringResource('shoppingcart.cs.1', $LocaleSetting)" disable-output-escaping="yes" />
                                                </b>
                                            </td>
                                            <td align="center" valign="middle">
                                                <b>
                                                    <xsl:value-of select="aspdnsf:StringResource('shoppingcart.cs.3', $LocaleSetting)" disable-output-escaping="yes" />
                                                </b>
                                            </td>
                                            <td align="right" valign="middle">
                                                <b>
                                                    <xsl:value-of select="aspdnsf:StringResource('shoppingcart.cs.96', $LocaleSetting)" disable-output-escaping="yes" />
                                                </b>
                                            </td>
                                        </tr>
                                        <xsl:apply-templates select="/root/OrderItems/lineitem" />
                                        <tr>
                                            <td colspan="3">
                                                <hr style="height: 2px; width:100%; color: #DDDDDD;" />
                                            </td>
                                        </tr>
                                    </table>
                                    <xsl:if test="OrderOptions!=''">
                                        <xsl:value-of select="aspdnsf:DisplayOrderOptions(OrderOptions, $LocaleSetting, 1)" disable-output-escaping="yes"/>
                                    </xsl:if>
                                    <table width="100%" border="0">
                                        <xsl:if test="/root/Order/OrderInfo/LevelID!=0 and /root/Order/OrderInfo/LevelDiscountAmount!=0">
                                            <tr>
                                                <td align="right" valign="top" class="OrderSummaryLabel">
                                                    <xsl:value-of select="aspdnsf:GetMLValue(LevelName)" />&#0160;<xsl:value-of select="aspdnsf:StringResource('order.cs.84', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td align="right" valign="top" class="OrderSummaryValue">
                                                    <xsl:value-of select="aspdnsf:FormatCurrency(/root/Order/OrderInfo/LevelDiscountAmount)" disable-output-escaping="yes" />
                                                </td>
                                            </tr>
                                        </xsl:if>
                                        <xsl:if test="(/root/Order/OrderInfo/CouponDiscountAmount!=0 or /root/Order/OrderInfo/CouponDiscountPercent!=0) and /root/Order/OrderInfo/CouponType=0">
                                            <xsl:variable name="cdisc" select="(/root/Order/OrderInfo/OrderSubtotal div (1-(/root/Order/OrderInfo/CouponDiscountPercent div 100)))-/root/Order/OrderInfo/OrderSubtotal" />
                                            <tr>
                                                <td align="right" valign="top" class="OrderSummaryLabel">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.85', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td align="right" valign="top" class="OrderSummaryValue"><xsl:value-of select="aspdnsf:FormatCurrency(/root/Order/OrderInfo/CouponDiscountAmount+$cdisc)" disable-output-escaping="yes" /></td>
                                            </tr>
                                        </xsl:if>
                                        <tr>
                                            <td align="right" valign="top" width="90%" class="OrderSummaryLabel">
                                                <xsl:value-of select="aspdnsf:StringResource('order.cs.53', $LocaleSetting)" disable-output-escaping="yes" />
                                                <xsl:if test="/root/System/VAT.Enabled='true' and number(OrderSubtotal)=number(OrderTotal)">
                                                    &#0160;(<xsl:value-of select="aspdnsf:StringResource('setvatsetting.aspx.6', $LocaleSetting)" disable-output-escaping="yes" />)
                                                </xsl:if>:
                                            </td>
                                            <td align="right" valign="top" class="OrderSummaryValue">
                                                <xsl:value-of select="aspdnsf:FormatCurrency(OrderSubtotal)" disable-output-escaping="yes" />
                                            </td>
                                        </tr>
                                        <xsl:value-of select="aspdnsf:OrderShippingCalculation(PaymentMethod, ShippingMethod, OrderShippingCosts, ShippingCalculationID, AddressIDs, number(allDownloads), number(allFreeShipping), number(allSystemproducts))" disable-output-escaping="yes" />
                                        <xsl:if test="(/root/System/VAT.Enabled='true' and aspdnsf:AppConfigBool('VAT.HideTaxInOrderSummary')='false') or /root/System/VAT.Enabled='false' or /root/System/CustomerVATSetting!=1">
                                            <tr>
                                                <td align="right" valign="top" class="OrderSummaryLabel">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.54', $LocaleSetting)" disable-output-escaping="yes" />
                                                    <xsl:if test="(StateTaxRate>0 or CountryTaxRate>0) and OrderTax>0">
                                                        (
                                                        <xsl:if test="StateTaxRate>0">
                                                            <xsl:value-of select="StateTaxRate" />%
                                                        </xsl:if>
                                                        <xsl:if test="CountryTaxRate>0">
                                                            <xsl:if test="StateTaxRate>0">
                                                                <xsl:value-of select="StateTaxRate" />:
                                                            </xsl:if>
                                                            <xsl:value-of select="CountryTaxRate" />%
                                                        </xsl:if>)
                                                    </xsl:if>:
                                                </td>
                                                <td align="right" valign="top" class="OrderSummaryValue">
                                                    <xsl:choose>
                                                        <xsl:when test="aspdnsf:ToUpper(PaymentMethod)!='REQUESTQUOTE'">
                                                            <xsl:value-of select="aspdnsf:FormatCurrency(OrderTax)" disable-output-escaping="yes" />
                                                        </xsl:when>
                                                        <xsl:otherwise>
                                                            <xsl:value-of select="aspdnsf:StringResource('order.cs.3', $LocaleSetting)" disable-output-escaping="yes" />
                                                        </xsl:otherwise>
                                                    </xsl:choose>
                                                </td>
                                            </tr>
                                        </xsl:if>

                                        <xsl:if test="number(CouponDiscountAmount) > 0 and CouponType = 2">
                                            <tr>
                                                <td align="right" valign="top" class="OrderSummaryLabel">
                                                    <xsl:value-of select="aspdnsf:StringResource('order.cs.83', $LocaleSetting)" disable-output-escaping="yes" />
                                                </td>
                                                <td align="right" valign="top" class="OrderSummaryValue">
                                                    <xsl:choose>
                                                        <xsl:when test="CouponDiscountAmount >= OrderTotal">
                                                            <xsl:value-of select="aspdnsf:FormatCurrency(OrderTotal)" disable-output-escaping="yes" />
                                                        </xsl:when>
                                                        <xsl:otherwise>
                                                            <xsl:value-of select="aspdnsf:FormatCurrency(CouponDiscountAmount)" disable-output-escaping="yes" />
                                                        </xsl:otherwise>
                                                    </xsl:choose>
                                                </td>
                                            </tr>
                                        </xsl:if>
                                        <tr>
                                            <td align="right" valign="top" class="OrderSummaryLabel">
                                                <xsl:choose>
                                                    <xsl:when test="number(CouponDiscountAmount)&gt;0">
                                                        <xsl:value-of select="aspdnsf:StringResource('order.cs.87', $LocaleSetting)" disable-output-escaping="yes" />
                                                    </xsl:when>
                                                    <xsl:otherwise>
                                                        <xsl:value-of select="aspdnsf:StringResource('order.cs.56', $LocaleSetting)" disable-output-escaping="yes" />
                                                    </xsl:otherwise>
                                                </xsl:choose>
                                            </td>
                                            <td align="right" valign="top" class="OrderSummaryValue">
                                                <xsl:choose>
                                                    <xsl:when test="aspdnsf:ToUpper(PaymentMethod)!='REQUESTQUOTE'">
                                                        <xsl:value-of select="aspdnsf:FormatCurrency(number(OrderTotal))" disable-output-escaping="yes" />
                                                    </xsl:when>
                                                    <xsl:otherwise>
                                                        <xsl:value-of select="aspdnsf:StringResource('order.cs.3', $LocaleSetting)" disable-output-escaping="yes" />
                                                    </xsl:otherwise>
                                                </xsl:choose>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </xsl:template>


            <xsl:template match="lineitem">
                <xsl:param name="LevelAllowsQuantityDiscounts" select="/root/Order/Orderinfo/LevelAllowsQuantityDiscounts" />
                <xsl:param name="pSizeOptionPrompt" select="aspdnsf:GetMLValue(SizeOptionPrompt)" />
                <xsl:param name="pColorOptionPrompt" select="aspdnsf:GetMLValue(ColorOptionPrompt)" />
                <xsl:param name="pTextOptionPrompt" select="aspdnsf:GetMLValue(TextOptionPrompt)" />
                <xsl:param name="LineItemRecID" select="ShoppingCartRecID" />


                <tr>
                    <td colspan="3">
                        <hr style="height: 1px; width:100%; color: #DDDDDD;" />
                    </td>
                </tr>
                <tr>
                    <td align="left" valign="top">
                      <div style="float:left;margin:5px;">
                        <xsl:value-of select="aspdnsf:LookupImageFramed(ProductID, 'product', 'icon', 1, $CustomerID, $LineItemRecID)" disable-output-escaping="yes"/>
                      </div>
                      <b>
                        <xsl:value-of select="aspdnsf:GetMLValue(OrderedProductName)" />
                        <xsl:if test="OrderedProductVariantName!=''">
                          -<xsl:value-of select="aspdnsf:GetMLValue(OrderedProductVariantName)" />
                        </xsl:if>
                        <BR/>
                        <xsl:value-of select="aspdnsf:GetMLValue(LocationName)" />
                        <xsl:if test="LocationNameVariantName!=''">
                          -<xsl:value-of select="aspdnsf:GetMLValue(LocationNameVariantName)" />
                        </xsl:if>
                        <BR/>
                        <xsl:value-of select="aspdnsf:GetMLValue(Base)" />
                        <xsl:if test="BaseVariantName!=''">
                          -<xsl:value-of select="aspdnsf:GetMLValue(BaseVariantName)" />
                        </xsl:if>
                        </b>
                        <br/><xsl:value-of select="aspdnsf:StringResource('order.cs.46', $LocaleSetting)" disable-output-escaping="yes" />: <xsl:value-of select="OrderedProductSKU" />
                        <xsl:if test="ChosenSize!=''"><br/>&#0160;&#0160;&#0160;&#0160;<xsl:choose><xsl:when test="$pSizeOptionPrompt=''"><xsl:value-of select="$DefaultSizeOptionPrompt" /></xsl:when><xsl:otherwise><xsl:value-of select="$pSizeOptionPrompt" /></xsl:otherwise></xsl:choose>:&#0160;<xsl:value-of select="ChosenSize" /></xsl:if>
                        <xsl:if test="ChosenColor!=''"><br/>&#0160;&#0160;&#0160;&#0160;<xsl:choose><xsl:when test="$pColorOptionPrompt=''"><xsl:value-of select="$DefaultColorOptionPrompt" /></xsl:when><xsl:otherwise><xsl:value-of select="$pColorOptionPrompt" /></xsl:otherwise></xsl:choose>:&#0160;<xsl:value-of select="ChosenColor" /></xsl:if>
                        <xsl:if test="TextOption!=''"><br/>&#0160;&#0160;&#0160;&#0160;<xsl:choose><xsl:when test="$pTextOptionPrompt=''"><xsl:value-of select="$DefaultTextOptionPrompt" /></xsl:when><xsl:otherwise><xsl:value-of select="$pTextOptionPrompt" /></xsl:otherwise></xsl:choose>:&#0160;<xsl:value-of select="TextOption" /></xsl:if>
                        <xsl:if test="isapack=1"><xsl:apply-templates select="/root/CustomOrderItems/Customitem[ShoppingCartRecID=$LineItemRecID]" /></xsl:if>
                        <xsl:if test="isakit=1">
                          <xsl:value-of select="aspdnsf:GetPictureTextDescriptionFromOrderCart($LineItemRecID)" disable-output-escaping="yes"/>
                          <xsl:apply-templates select="/root/KitOrderItems/kititem[ShoppingCartRecID=$LineItemRecID]" />
                        </xsl:if>
                        <xsl:for-each select="/root/OrderGiftCards/GiftCard[ShoppingCartRecID=$LineItemRecID]">
                            <br/>Serial Number: <xsl:value-of select="SerialNumber" />
                        </xsl:for-each>
                        <br/>

                        <xsl:if test="/root/Order/OrderInfo/multiship=1 or (/root/Order/OrderInfo/hasgiftregistryitems=1 and IsDownload=0 and IsSystem=0)">
                            <br/>
                            <xsl:value-of select="aspdnsf:StringResource('shoppingcart.cs.87')" disable-output-escaping="yes" />(<xsl:value-of select="ShippingAddressID" disable-output-escaping="yes" />)
                            <xsl:if test="GiftRegistryForCustomerID&gt;0">
                                &#0160;<xsl:value-of select="aspdnsf:StringResource('checkoutshippingmult.aspx.15')" disable-output-escaping="yes" />
                            </xsl:if>
                            <xsl:value-of select="aspdnsf:DisplayAddressString(ShippingAddressID)" disable-output-escaping="yes" />
                            <div>
                                <xsl:value-of select="aspdnsf:StringResource('order.cs.68')" disable-output-escaping="yes" />&#0160;
                                <xsl:value-of select="ShippingMethod" disable-output-escaping="yes" />
                            </div>

                        </xsl:if>
                        <xsl:if test="Notes!='' and aspdnsf:AppConfigBool('AllowShoppingCartItemNotes')='true' and IsSystem=0">
                            <br/><br/><b>
                                <xsl:value-of select="aspdnsf:StringResource('shoppingcart.cs.86')" disable-output-escaping="yes" />
                            </b>
                            <br/>
                            <xsl:value-of select="Notes" disable-output-escaping="yes" />
                        </xsl:if>

                    </td>
                    <td align="center" valign="top">
                        <xsl:value-of select="Quantity" />
                    </td>
                    <td align="right" valign="top">
                        <xsl:choose>
                            <xsl:when test="/root/System/VAT.Enabled='true' and IsTaxable=1 and /root/System/CustomerVATSetting=1 and (boolean(/root/Order/OrderInfo/LevelHasNoTax) or /root/Order/OrderInfo/LevelHasNoTax=0)">
                                <xsl:value-of select="aspdnsf:FormatCurrency(number(OrderedProductPrice) + ((round((OrderedProductPrice div Quantity)*TaxRate) div 100)*Quantity))" disable-output-escaping="yes" />
                            </xsl:when>
                            <xsl:otherwise>
                                <xsl:value-of select="aspdnsf:FormatCurrency(OrderedProductPrice)" disable-output-escaping="yes" />
                            </xsl:otherwise>
                        </xsl:choose>

                        <xsl:if test="$LevelAllowsQuantityDiscounts=1 and OrderedProductQuantityDiscountID>0 and OrderedProductQuantityDiscountPercent!=0">
                            <small>
                                (
                                <xsl:value-of select="format-number(OrderedProductQuantityDiscountPercent, '#0')" />
                                <xsl:value-of select="aspdnsf:StringResource('order.cs.49', $LocaleSetting)" disable-output-escaping="yes" />)
                            </small>
                        </xsl:if>
                        
                        <xsl:if test="/root/System/VAT.Enabled='true' and IsTaxable=1 and (boolean(/root/Order/OrderInfo/LevelHasNoTax) or /root/Order/OrderInfo/LevelHasNoTax=0)">
                            <br/>VAT: <xsl:value-of select="aspdnsf:FormatCurrency((round((OrderedProductPrice div Quantity)*TaxRate) div 100)*Quantity)" />
                        </xsl:if>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">&#0160;</td>
                </tr>
            </xsl:template>

            <xsl:template match="Customitem">
                <xsl:param name="pProductName" select="aspdnsf:GetMLValue(ProductName)"></xsl:param>
                <xsl:param name="pProductVariantName" select="aspdnsf:GetMLValue(ProductVariantName)"></xsl:param>
                <br/>
                 &#0160;&#0160;&#0160;&#0160;- (<xsl:value-of select="Quantity" />)&#0160;<xsl:value-of select="$pProductName" disable-output-escaping="yes"/><xsl:if test="$pProductVariantName!=''">&#0160;-&#0160;<xsl:value-of select="$pProductVariantName" disable-output-escaping="yes"/></xsl:if>,&#0160;<xsl:value-of select="ProductSKU" />
            </xsl:template>
            


            <xsl:template match="kititem">
                <xsl:param name="pKitItemName" select="aspdnsf:GetMLValue(KitItemName)"></xsl:param>
                <xsl:param name="pProductVariantName" select="aspdnsf:GetMLValue(ProductVariantName)"></xsl:param>
                <br/>
                 &#0160;&#0160;&#0160;&#0160;-&#0160;<xsl:value-of select="$pKitItemName" disable-output-escaping="yes"/>
                <xsl:if test="KitGroupTypeID=4 or KitGroupTypeID=5">:&#0160;&#0160;<b><xsl:value-of select="TextOption" /></b></xsl:if>
                <xsl:if test="KitGroupTypeID=6">
                    <br/><img src="{/root/System/StoreUrl}{TextOption}"  border="0" /></xsl:if>
            </xsl:template>
            


        </xsl:stylesheet>
    </PackageTransform>
</package>